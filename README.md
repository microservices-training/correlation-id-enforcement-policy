# correlation-id-enforcement-policy
Correlation ID Enforcement Policy

## Introduction
In order to allow end to end traceability of API calls whether to a single API or right through the layers of an API Led Architecture, best practice dictates that correlation id's are used to uniquely identify each request. The are usually provided by the client as HTTP Headers and are logged by both the client and server during an API call. Certain use cases require a correlation id as a mandatory input to an API call however not all clients may be able to provide this easily, as such the policy described here can be used to ensure some level of traceability is maintained. It can do this by generating an ID for a client and injecting it as a HTTP Header into the request, or by persisting an ID provided by a client and returning it back as a HTTP Header in an API Response.

## Implementation
To achieve the aims described in the introduction, the functionality required is implemented in a Mule 4 Custom Policy. The custom policy has the configuration parameters described in Figure 1.

The Policy has 2 blocks of functionality each enabled by the respective flags described in Figure 1. The first block executes before the http-policy:execute-next tag of the policy, this functionality checks if a correlation id header has been passed in the HTTP Request. If a Correlation ID is not present, it will generate one. The second block of functionality after the http-policy:execute-next tag, will send back the correlation id as an HTTP Header on the API Response to ensure the API Clients receive the correlation id they sent in (or was generated by the policy) on the response.

| Parameter       | Description     | Default     |
| :------------- | :----------: | -----------: |
| Correlation ID Header Name | The name of the HTTP Header used as a Correlation ID. | X-CORRELATION-ID |
| Generate ID | This flag determines whether an ID is generated if the specified header is not found. | true |
| Return ID | This flag determines whether an ID is returned on the HTTP Response. | true |

Figure 1.

## Usage Considerations
It is important to consider when using this policy that a client is made aware it is in use so that even if they do not send a Correlation ID to the API, they are aware that one will be provided on the response. This will also require RAML Specifications of API's to which the policy will be applied to be updated to show the request and/or response headers . One consideration to be made is with regards to policy ordering, if for example you use the OOTB Message Logging Policy to log response headers, and it executes before this policy, it will not log the response header this policy can add.

## Deployment
Once packaged into the standard policy structure, follow the instructions here to deploy to your Anypoint Platform Exchange - https://docs.mulesoft.com/api-manager/2.x/custom-policy-uploading-to-exchange. Some points to consider when deploying:

* Ensure the Group ID in your POM.xml file is the same of the org ID of the Anypoint Organisation you wish to deploy this policy to.
* Ensure you have added a server with exchange credentials to your Maven settings.xml file. The server ID you set must match the one referenced in the POM file, for example the ID used in the file here is "Repository".
* Ensure your deployment user has Exchange Contributor Permissions.
